# 併發相關 原子操作

今天來介紹原子操作，簡單的說原子操作就是這個操作要馬完全完成，要嘛都沒完成，下面就來看看C++中的原子變數

## atomic_T

`atomic`實際上支援大多數基本類型(int, char, float, bool等)，然後每個`atomic`都會有以下函數

### 建構函數

因為原子變數本身是原子特性，所以原子變數是不能複製或移動的

```cpp
#include <iostream>
#include <thread>
#include <mutex>
#include <atomic>

using namespace std;

int main(int argc, char const *argv[])
{
    atomic<int> aInt(0);
    // atomic<int> aInt2(move(aInt));  atomic (const atomic&) = delete;
    atomic<int> aInt3 = 0; // operator= 是可以的

    return 0;
}
```

### is_lock_free函數

`is_lock_free`是來確認當前`atomic`對象是否支持無鎖操作，無鎖操作在day30會提到，主要原子操作的關鍵是在同步化中取代用互斥鎖`mutex`的操作，期望是提升性能

```cpp
int main(int argc, char const *argv[])
{
    atomic<int> aInt(0);
    cout << "atomic<int> is " << aInt.is_lock_free() << endl;;

    return 0;
}
```

### memory_order

C++中的記憶體排序共有六種，主要是用於控制記憶體的存取順序，分為以下六種

| 類型                 | 名稱     | 行為                                           | 場景                                                     |
| -------------------- | -------- | ---------------------------------------------- | -------------------------------------------------------- |
| memory_order_relaxed | 放鬆排序 | 不提供同步，也不限制記憶體順序。只保證原子性。 | 常用於統計計數器、非同步事件紀錄器等不需要同步的資料更新 |
| memory_order_acquire | 取得排序 | 讀操作之後的操作不能被重排序這個讀之前。 | 鎖的讀取、條件判斷，用於同步某資源是否可用 |
| memory_order_release | 釋放排序 | 寫操作之前的操作不能被重排序這個寫之後。 | 解鎖、資源狀態標記為完成。通常與acquire 搭配 |
| memory_order_acq_rel | 取得+釋放排序 | 同時具備acquire和release行為，屬於RMW操作(Read-Modify-Write)。 | 解鎖、資源狀態標記為完成。通常與acquire 搭配 |
| memory_order_seq_cst | 序列一致性 (Sequentially Consistent) | 預設值，跨執行緒可觀察的單一總序。 | 解鎖、資源狀態標記為完成。通常與acquire 搭配 |
| memory_order_consume | 消費排序 | 資料相依關係下的讀取順序。 | 不建議使用，因為編譯器尚未支援，目前功能等同 memory_order_acquire |

總的來說，性能上其實 寬鬆排序(memory_order_relaxed) > 獲取 - 釋放排序(memory_order_acquire、memory_order_release、memory_order_acq_rel、memory_order_consume) > 一致排序 (memory_order_seq_cst)，因為從同步的角度來看，越高的一致性，代表越多的同步，處理器之間就可能進行大量的同步操作。

#### memory_order_seq_cst



```cpp


```

### compare_exchange_weak、compare_exchange_strong



```cpp

```

## 參考

[C++ 併發處理實戰](https://www.tenlong.com.tw/products/9786263240032?list_name=srh)
